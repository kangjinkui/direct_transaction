# 강남구 설맞이 직거래 장터 온라인 시스템 PRD - MVP (KISS)

**버전**: 2.0 (KISS 최종)
**작성일**: 2025-12-16
**기술 스택**: Ruby on Rails 8, Hotwire, PostgreSQL, Redis, Sidekiq, AWS (EB, RDS, S3), 카카오 알림톡, SMS
**대상**: 소비자, 농가(타입 A/B), 구청 관리자

---

## 1. 프로젝트 개요

### 목표
전화/수기 주문의 비효율을 해소하고, 고령 농가를 고려한 간단한 온라인 주문/승인 시스템 구축

### 핵심 가치
- 24시간 온라인 주문 가능
- 농가 최소 조작 승인 (또는 자동 승인)
- 구청의 효율적 모니터링 및 지원

### MVP 범위
- **핵심 가설 검증**: "전화 대신 온라인 주문 + 농가 간단 승인"만 검증
- **복잡도 최소화**: 정책 엔진, 고급 보안, 인프라 자동화 보류
- **운영 부담 최소화**: 수동 입금 확인, 기본 모니터링만

---

## 2. 사용자 페르소나

### 소비자
- **연령**: 30-60대
- **니즈**: 온라인 주문, 알림 수신, 주문 상태 확인

### 농가 타입 A (상위 10개)
- **연령**: 50-70대
- **특징**: 낮은 디지털 친숙도
- **니즈**: 알림톡 링크로 간단한 승인/거절

### 농가 타입 B (70개)
- **연령**: 60-80대
- **특징**: 웹 접속 어려움
- **니즈**: 자동 승인 + 일간 요약 문자

### 구청 관리자
- **니즈**: 주문 모니터링, 입금 확인, 미응답 처리

---

## 3. 기능 요구사항

### 3.1 소비자

#### 가입/로그인
- 카카오 또는 네이버 OAuth
- 이메일/비밀번호 방식도 지원

#### 상품 조회/주문
- 농가/카테고리별 브라우징
- 재고 상태 표시 (⭕ 가능 / ❌ 품절)
- 장바구니 → 주문 생성

#### 주문 관리
- 주문 목록 및 상태 확인
- **상태 표시 (명확하게)**:
  - `농가 검토 중` (farmer_review)
  - `✅ 농가 승인됨, 입금해주세요` (confirmed)
  - `💰 입금 신고함, 관리자 확인 중` (payment_pending)
  - `🎉 입금 확인 완료` (completed)
- 농가 계좌 확인 (마스킹: 뒤 4자리만 노출)
- 입금 완료 신고 버튼
- 농가 승인 전 취소 가능

#### 알림
- 농가 승인/거절 시 알림
- 입금 마감 임박 알림

---

### 3.2 농가

#### 타입 A (수동 승인)
- **알림**: 카카오 알림톡 링크 수신
- **승인 화면**: 주문 목록 → 승인/거절 버튼
- **인증**: 30분 만료, 1회성 토큰 (재사용 차단)
- **재고 관리**: 재고 수량 수정, 품절 토글
- **계좌 관리**: 계좌 정보 수정 (암호화 저장)

#### 타입 B (자동 승인)
- **자동 승인**: 재고 있으면 자동 `confirmed` 처리
- **재고 소진 시**: 주문 차단 + 알림톡 발송
- **일간 요약**: 오후 6시 SMS (총 주문 건수/금액)
- **재고 관리**: 선택적 (전화로 구청에 요청 가능)

#### 공통
- **타임아웃**: 24시간 미응답 시 자동 취소
- **재고 차감**: 주문 승인 시 자동 차감

---

### 3.3 구청 관리자

#### 주문 관리
- 전체 주문 목록 (필터: 미응답/승인됨/입금 대기/완료)
- 미응답 주문 알림
- 대리 승인/거절 (타임아웃 시)

#### 입금 확인
- 입금 신고 목록
- 전화/문자 확인 후 수동 승인
- 관리자 메모 기록

#### 농가/상품 관리
- 농가 등록/수정 (기본 CRUD)
- 상품 등록/수정
- 재고 수정

#### 데이터
- 주문/판매 통계 (기본)
- CSV 다운로드

---

## 4. 보안/프라이버시

### 인증/인가

#### 소비자
- OAuth (카카오/네이버) 또는 이메일/비밀번호
- 세션 타임아웃: 30분

#### 농가
- **알림톡 링크**: 30분 만료 토큰 (JWT)
- **1회성**: `used_at` 체크로 재사용 차단
- **만료/폐기**: Redis SET (30분 TTL)

#### 관리자
- **평시**: 주 1회 SMS OTP 재인증 (7일 세션)
- **행사 중 (1주)**: 매 로그인 SMS OTP 강제
- 이유: 평시 계정 탈취 → 행사 악용 방지

### 데이터 보호
- 계좌 정보 암호화 (attr_encrypted)
- 알림/화면은 계좌 뒤 4자리만 노출
- 전체 계좌는 인증 후 모달에서만 표시
- TLS/HTTPS 전 구간

### 감사 로그
- **Orders 테이블에 JSONB 필드**:
  ```ruby
  status_history: jsonb
  # [{status: 'confirmed', at: '...', by_id: 123, by_type: 'Farmer'}, ...]

  # 쿼리/레포트용 캐시 컬럼
  last_status_changed_at: datetime
  last_status_changed_by_id: integer
  last_status_changed_by_type: string  # User/Farmer/Admin
  ```
- **추후 확장**: 주문 1만 건 초과 시 `order_status_logs` 테이블 분리

---

## 5. 시스템 아키텍처

### Web
- Rails 8 + Hotwire (Turbo + Stimulus)
- ViewComponent (재사용 가능한 컴포넌트)

### Worker
- Sidekiq 큐 분리:
  - **critical**: 주문 상태 변경
  - **default**: 알림 발송
- 알림 폭주 시 critical 큐 보호

### 데이터
- PostgreSQL (RDS 단일 AZ)
- Redis (세션/캐시/큐/토큰 폐기)
- S3 (상품 이미지만)

### 배포
- Elastic Beanstalk (수동 배포)
- 환경 변수: `.env` → EB 환경 변수

### 모니터링
- 기본 헬스체크 (`/health`)
- CloudWatch 로그
- 관리자 대시보드 (미응답 주문 알림)

### 보류
- ❌ Terraform/IaC
- ❌ Blue/Green 배포
- ❌ APM (Elastic APM, New Relic 등)
- ❌ 멀티 AZ, 읽기 복제본

---

## 6. 데이터 모델

### 제거된 테이블
- ❌ FarmerPolicies (전역 타임아웃만 사용)
- ❌ PaymentEvents (Payments.admin_note로 대체)
- ❌ AccessTokens (Notifications로 통합)
- ❌ AuditEvents (Orders.status_history로 대체)

### 최종 모델

```ruby
Users
  - id, name, phone, email, oauth_provider, role, last_2fa_at

Farmers
  - id, business_name, phone, account_info_enc
  - approval_mode (enum: manual/auto)  # A=manual, B=auto
  - stock_quantity (integer)
  - notification_method (enum: kakao/sms)

Products
  - id, farmer_id, name, price, category
  - stock_quantity (integer)
  - is_available (boolean)

Orders
  - id, user_id, farmer_id, total_amount, status, order_number
  - status_history (jsonb)
  - last_status_changed_at, last_status_changed_by_id, last_status_changed_by_type
  - timeout_at, confirmed_at, completed_at, cancelled_at

OrderItems
  - id, order_id, product_id, quantity, price

Payments
  - id, order_id, amount, status (enum: pending/verified)
  - admin_note (text)  # 관리자 확인 메모

Notifications
  - id, order_id, farmer_id, type, channel (enum: kakao/sms)
  - token_jti (string)  # 토큰 ID
  - used_at, expires_at, sent_at, status
```

---

## 7. 상태 머신

### Order 상태 (5단계)

```
pending → farmer_review → confirmed → payment_pending → completed
          └─ rejected              └─ cancelled
```

#### 상태 정의
- **pending**: 주문 생성됨
- **farmer_review**: 농가 검토 중
- **confirmed**: ✅ 농가 승인됨, 입금 대기 중
- **payment_pending**: 💰 소비자 입금 신고함, 관리자 확인 대기
- **completed**: 🎉 입금 확인 완료
- **rejected**: 농가 거절
- **cancelled**: 소비자 취소 또는 타임아웃

#### 타임아웃
- `farmer_review` 상태에서 24시간 미응답 → 자동 `cancelled`

### Payment 상태

```
pending → verified
```

- **pending**: 입금 대기
- **verified**: 관리자 확인 완료

---

## 8. 핵심 워크플로우

### 8.1 소비자 주문

```
1. 상품 선택 → 장바구니 → 주문 생성 (pending)
2. 주문 자동 전환 (pending → farmer_review)
3. 농가 알림 발송 (카카오 알림톡)
4. 농가 승인 → confirmed
5. 소비자: 계좌 확인 → 입금 → "입금 완료" 신고
6. 주문 상태: confirmed → payment_pending
7. 관리자: 전화/문자 확인 → 수동 승인
8. 주문 상태: payment_pending → completed
```

#### 타임아웃
- `farmer_review` 24시간 미응답 → `cancelled`

### 8.2 농가 타입 A (수동 승인)

```
1. 알림톡 링크 수신 (30분 만료)
2. 링크 클릭 → 주문 목록 화면
3. 토큰 검증 (만료/재사용 차단)
4. 승인 또는 거절 버튼 클릭
5. 주문 상태 변경 + 소비자 알림
6. 재고 자동 차감 (승인 시)
```

#### 실패 시나리오
- **토큰 만료**: "링크가 만료되었습니다" 안내
- **재사용**: "이미 처리된 링크입니다" 안내
- **타임아웃**: 24시간 후 자동 취소

### 8.3 농가 타입 B (자동 승인)

```
1. 주문 생성 (pending → farmer_review)
2. 재고 체크:
   - 재고 있음 → 자동 confirmed + 재고 차감
   - 재고 없음 → 주문 차단 + 농가 알림톡
3. 일간 요약 SMS (오후 6시)
   - 내용: "오늘 주문 10건, 총 150,000원"
```

### 8.4 구청 관리자

#### 미응답 주문 처리
```
1. 대시보드에서 미응답 주문 확인
2. 농가에 전화 연락
3. 승인/거절 결정 → 대리 처리
4. 주문 상태 변경 + 소비자 알림
```

#### 입금 확인
```
1. "입금 신고" 목록 확인
2. 농가에 전화/문자로 입금 확인
3. 확인 완료 → 수동 승인
4. 관리자 메모 기록 (예: "1/15 전화 확인")
5. 주문 상태: payment_pending → completed
```

---

## 9. 알림 전략 (Fallback)

### 우선순위
```
1. 카카오 알림톡 시도
   ↓ 실패 시 (API 오류 코드 or 5분 미수신)
2. SMS 자동 발송
   ↓ 실패 시
3. 관리자 대시보드 알림 (+ Slack/이메일)
```

### 실패 판정 기준
- **기술적 실패**: HTTP 오류 (4xx/5xx)
- **전송 실패**: 카카오 API 실패 코드
- **수신 미확인**: 5분 내 토큰 미사용 (선택적)

### 재시도
- **1회만** 재시도 (DLQ/백오프 보류)

### 큐 분리
- **critical**: 주문 상태 변경 (알림 폭주에 영향 받지 않음)
- **default**: 알림 발송

### 알림 내용
```
[농가 승인 알림]
주문번호: #12345
상품: 딸기 2kg x 2개
금액: 40,000원
[승인하기] 링크

[소비자 승인 알림]
✅ 농가 승인 완료
입금 계좌: 농협 ****1234
금액: 40,000원
기한: 1/20 18:00까지
```

---

## 10. 비기능 요구사항

### 성능
- **응답 시간**: P95 < 500ms (주문 생성/조회)
- **동시 접속**: 100명 (행사 첫날 피크 가정)
- **주문 처리**: 초당 5건 (충분)

### 가용성
- **평시**: 99% (주말 점검 가능)
- **행사 중 (1주)**: 99.5%
- **백업**: 일 1회 자동 스냅샷

### 보안
- TLS/HTTPS 전 구간
- 계좌 정보 암호화
- SQL Injection, XSS 방어 (Rails 기본)
- 레이트 리미팅 (선택적)

### 접근성
- 모바일 우선 (반응형)
- 글자 크기 ≥ 16px
- 대비 AA (WCAG)
- 터치 영역 ≥ 44px

### 로그
- 기본 Rails 로그
- CloudWatch 로그 (7일 보관)
- PII 마스킹 (선택적)

---

## 11. 리스크 및 대응

### 농가 미응답
- **리스크**: 농가가 알림을 못 보거나 무시
- **대응**:
  - 카카오 실패 시 SMS 백업
  - 24시간 타임아웃 → 자동 취소
  - 구청이 대시보드에서 확인 → 대리 처리

### 주문 폭주
- **리스크**: 행사 첫날 동시 주문 몰림
- **대응**:
  - 재고 차감으로 한도 관리
  - Sidekiq 큐 분리로 알림 지연 시에도 주문 처리 가능

### 입금 불일치
- **리스크**: 소비자가 잘못된 계좌로 입금 또는 금액 오류
- **대응**:
  - 관리자가 전화로 확인 후 수동 승인
  - 관리자 메모 기록

### 계좌 변경 후 오입금
- **리스크**: 농가가 계좌 변경 후 소비자가 이전 계좌로 입금
- **대응**:
  - 주문 상세 화면 진입 시 최신 계좌 확인
  - 불일치 시 경고 표시
  - 알림에 계좌 마지막 4자리 포함

---

## 12. 로드맵/마일스톤

### Phase 1: 핵심 기능 (2주)
- [ ] 사용자/농가/관리자 인증
- [ ] 상품 CRUD
- [ ] 주문 생성/상태 관리
- [ ] 농가 승인/거절 (타입 A)
- [ ] 자동 승인 (타입 B)
- [ ] 카카오 알림톡 연동
- [ ] SMS 백업

### Phase 2: 입금 관리 (1주)
- [ ] 입금 신고 기능
- [ ] 관리자 입금 확인 UI
- [ ] 타임아웃 자동 취소

### Phase 3: 운영 지원 (1주)
- [ ] 관리자 대시보드 (미응답/입금 대기)
- [ ] CSV 다운로드
- [ ] 일간 요약 SMS (타입 B)

### Phase 4: 테스트/배포 (1주)
- [ ] 통합 테스트 (주요 워크플로우)
- [ ] EB 배포 설정
- [ ] 헬스체크/모니터링

---

## 13. 운영/지원 계획

### 고객 지원
- **FAQ**: 주문 방법, 입금 방법, 취소 방법
- **전화**: 긴급 문의 (09:00-18:00)
- **이메일**: 비긴급 문의

### 농가 지원
- **사전 교육**: 튜토리얼 영상 (3분)
- **1:1 담당자**: 구청 직원 배정
- **주간 모니터링**: 미응답 농가 전화 확인

### 시스템 모니터링
- **일일**: 미처리 주문 확인
- **주간**: 통계 요약 (주문 건수/금액)
- **행사 후**: 데이터 분석 및 개선안

---

## 14. 성공 지표 (KPI)

### 주문 전환율
- **목표**: 주문 생성 대비 완료율 > 70%

### 농가 응답률
- **목표**: 24시간 내 응답률 > 85%

### 시스템 가용성
- **목표**: 행사 중 99.5%

### 평균 처리 시간
- **목표**: 주문 생성 → 완료 < 48시간

### 사용자 만족도 (정성)
- **소비자**: > 4.0/5.0
- **농가**: > 3.5/5.0
- **구청**: 운영 효율 체감

---

## 15. 주요 화면/UX 개요

### 소비자
- **메인**: 농가 목록, 카테고리 필터
- **상품 상세**: 재고 상태 (⭕/❌), 가격, 주문 수량
- **장바구니**: 여러 농가 상품 혼합 가능
- **주문 목록**: 상태별 필터 (검토 중/승인됨/완료)
- **주문 상세**:
  - 상태 타임라인
  - 계좌 정보 (마스킹 → 클릭 시 전체 표시)
  - "입금 완료" 신고 버튼

### 농가 타입 A
- **알림톡 링크**: "새 주문이 있습니다 [확인하기]"
- **주문 목록**: 승인 대기 주문만 표시
- **승인/거절**: 버튼 2개, 거절 사유 입력 (선택)
- **만료 안내**: "링크가 만료되었습니다" (30분 경과)

### 농가 타입 B
- **일간 요약 SMS**: "오늘 주문 10건, 총 150,000원"
- **재고 소진 알림**: "딸기 재고가 소진되었습니다"

### 구청 관리자
- **대시보드**:
  - 미응답 주문 (24시간 초과)
  - 입금 대기 주문
  - 오늘의 통계 (주문 건수/금액)
- **주문 상세**:
  - 대리 승인/거절 버튼
  - 입금 확인 버튼
  - 관리자 메모 입력
- **농가/상품 관리**: 기본 CRUD
- **데이터**: CSV 다운로드

---

## 16. MVP에서 제거된 복잡도

### 제거/보류된 기능

| 기능 | 원 PRD | MVP |
|------|--------|-----|
| 정책 엔진 | FarmerPolicies 테이블, 농가별 세밀 설정 | 전역 타임아웃만 |
| 농가 인증 | JWT+PIN+디바이스 바인딩+MFA | 30분 1회성 토큰 |
| 입금 관리 | 자동 입금 조회, 증빙 업로드, PaymentEvents | 관리자 수동 확인+메모 |
| 감사 로그 | AuditEvents 테이블 | Orders.status_history (JSONB) |
| 알림 채널 | 우선순위+DLQ+백오프+일간 요약 | 카카오→SMS fallback, 1회 재시도 |
| 관리자 MFA | 항시 MFA | 주 1회 (행사 중 매번) |
| 배포/인프라 | Terraform, Blue/Green, APM | 수동 EB 배포, 기본 모니터링 |
| 큐 분리 | critical/notify/default/low | critical/default만 |
| 데이터베이스 | 멀티 AZ, 읽기 복제본 | 단일 AZ |

### 향후 확장 가능성
- 주문량 증가 시: order_status_logs 테이블 분리
- 입금 자동화: PaymentEvents 추가
- 고급 보안: PIN 2차 인증, 디바이스 바인딩
- 인프라 자동화: Terraform, CI/CD 파이프라인

---

## 17. 개정 이력

- **1.0** (2025-11): 초기 PRD
- **1.1** (2025-11): 보안/확장성/정책/결제 상태 강화
- **1.2** (2025-11): 통합본, plan.md 정합성 반영
- **2.0** (2025-12-16): KISS 최종 - 복잡도 제거, 현실 제약 반영

---

## 참고 문서

- [원본 PRD (prd_final.md)](./prd_final.md)
- [설계 문서 (design.md)](./design.md)
- [Phase 계획 (plan.md)](./plan.md)
