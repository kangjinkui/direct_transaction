<div class="page-container py-8 space-y-6">
  <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
    <div>
      <h1 class="text-3xl font-bold">주문 관리</h1>
      <p class="text-sm text-base-content/70">미응답 및 입금 대기 주문을 확인합니다.</p>
    </div>
    <div class="flex flex-wrap gap-2">
      <%= link_to "CSV 다운로드", admin_orders_path(format: :csv, scope: @scope, imminent: params[:imminent], sort: @sort), class: "btn btn-ghost btn-sm" %>
      <%= link_to "관리자 대시보드", admin_dashboard_path, class: "btn btn-primary btn-sm" %>
    </div>
  </div>

  <% if @stats[:timed_out].positive? %>
    <div class="alert alert-error">
      <span>타임아웃이 지난 주문이 <strong><%= @stats[:timed_out] %>건</strong> 있습니다. 즉시 확인이 필요합니다.</span>
    </div>
  <% elsif @imminent_only %>
    <div class="alert alert-warning">
      <span>타임아웃 임박 주문만 필터링 중입니다.</span>
    </div>
  <% end %>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="card bg-base-100 shadow-lg">
      <div class="card-body">
        <p class="text-sm text-base-content/70">오늘 주문 수</p>
        <p class="text-2xl font-bold"><%= @summary[:orders_today] %>건</p>
      </div>
    </div>
    <div class="card bg-base-100 shadow-lg">
      <div class="card-body">
        <p class="text-sm text-base-content/70">오늘 주문 금액</p>
        <p class="text-2xl font-bold">
          <%= number_to_currency(@summary[:amount_today] / 100.0, unit: "", precision: 0) %>원
        </p>
      </div>
    </div>
    <div class="card bg-base-100 shadow-lg">
      <div class="card-body">
        <p class="text-sm text-base-content/70">오늘 완료</p>
        <p class="text-2xl font-bold"><%= @summary[:completed_today] %>건</p>
      </div>
    </div>
  </div>

  <div class="flex flex-wrap gap-2 items-center">
    <%= link_to "미응답 주문 (#{@stats[:farmer_review]})",
                admin_orders_path(scope: :farmer_review, sort: @sort),
                class: "btn btn-sm #{params[:scope].to_s == 'payment_pending' ? 'btn-ghost' : 'btn-primary'}" %>
    <%= link_to "입금 대기 (#{@stats[:payment_pending]})",
                admin_orders_path(scope: :payment_pending, sort: @sort),
                class: "btn btn-sm #{params[:scope].to_s == 'payment_pending' ? 'btn-primary' : 'btn-ghost'}" %>
    <%= link_to "타임아웃 임박",
                admin_orders_path(scope: @scope, imminent: true, sort: @sort),
                class: "btn btn-sm #{params[:imminent] ? 'btn-warning' : 'btn-ghost'}" %>
    <span class="text-sm text-base-content/70">타임아웃 경과: <strong><%= @stats[:timed_out] %>건</strong></span>
  </div>

  <% if @orders.empty? %>
    <div class="card bg-base-100 shadow-lg">
      <div class="card-body text-sm text-base-content/70">해당 조건의 주문이 없습니다.</div>
    </div>
  <% else %>
    <div class="card bg-base-100 shadow-lg">
      <div class="card-body p-0">
        <div class="overflow-x-auto">
          <table class="table">
            <thead>
              <tr>
                <th>주문번호</th>
                <th>상태</th>
                <th>농가</th>
                <th>고객</th>
                <th>
                  <%= link_to "타임아웃",
                              admin_orders_path(scope: @scope, sort: :timeout_at, imminent: params[:imminent]),
                              class: "link" %>
                </th>
                <th>입금 상태</th>
                <th class="text-right">액션</th>
              </tr>
            </thead>
            <tbody>
              <% @orders.each do |order| %>
                <% timed_out = order.timeout_at && order.timeout_at <= @now %>
                <% imminent = !timed_out && order.timeout_at && order.timeout_at <= @now + 2.hours %>
                <tr class="<%= timed_out ? 'bg-error/10' : imminent ? 'bg-warning/10' : '' %>">
                  <td>
                    <div class="font-mono text-xs"><%= order.order_number %></div>
                    <div class="mt-1">
                      <%= link_to "상세 보기", admin_order_path(order), class: "link link-primary text-xs" %>
                    </div>
                  </td>
                  <td><%= render BadgeComponent.new(status: order.status) %></td>
                  <td><%= order.farmer.business_name %></td>
                  <td><%= order.user.name %></td>
                  <td><%= order.timeout_at ? l(order.timeout_at, format: :short) : "-" %></td>
                  <td><%= order.payment&.status || "-" %></td>
                  <td class="text-right space-x-2">
                    <% if order.may_confirm_order? || order.may_submit_for_review? %>
                      <%= button_to "대리 승인",
                                    confirm_admin_order_path(order, scope: @scope),
                                    method: :post,
                                    class: "btn btn-primary btn-xs" %>
                    <% end %>
                    <% if order.may_cancel_order? %>
                      <%= button_to "대리 취소",
                                    cancel_admin_order_path(order, scope: @scope),
                                    method: :post,
                                    form: { data: { turbo_confirm: "정말 취소할까요?" } },
                                    class: "btn btn-error btn-xs" %>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  <% end %>
</div>
